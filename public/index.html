<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تحلیلگر ایران افیکس</title>
  <style>
    /* استایل‌های عمومی */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background-color: #2c3e50;
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .logo {
      height: 50px;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      padding: 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    }
    
    /* فرم ورود نماد */
    .input-group {
      display: flex;
      margin-bottom: 30px;
    }
    #symbol-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    #analyze-btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 25px;
      margin-right: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    #analyze-btn:hover {
      background-color: #2980b9;
    }
    
    /* نمودار میله‌ای */
    .bar-container {
      margin: 30px 0;
    }
    .bar-title {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .buy-title {
      color: #27ae60;
    }
    .sell-title {
      color: #e74c3c;
    }
    .bar-chart {
      display: flex;
      height: 50px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .buy-bar {
      background-color: #27ae60;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }
    .sell-bar {
      background-color: #e74c3c;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }
    
    /* سطوح حمایت و مقاومت */
    .levels-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 30px 0;
    }
    .supports, .resistances {
      padding: 20px;
      border-radius: 10px;
    }
    .supports {
      background-color: rgba(39, 174, 96, 0.1);
      border-right: 4px solid #27ae60;
    }
    .resistances {
      background-color: rgba(231, 76, 60, 0.1);
      border-right: 4px solid #e74c3c;
    }
    .level-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed #ddd;
    }
    
    /* سیگنال */
    .signal {
      padding: 20px;
      border-radius: 10px;
      margin: 30px 0;
    }
    .signal-buy {
      background-color: rgba(39, 174, 96, 0.1);
      border-right: 4px solid #27ae60;
    }
    .signal-sell {
      background-color: rgba(231, 76, 60, 0.1);
      border-right: 4px solid #e74c3c;
    }
    .signal-title {
      font-size: 22px;
      margin-bottom: 10px;
    }
    .signal-buy .signal-title {
      color: #27ae60;
    }
    .signal-sell .signal-title {
      color: #e74c3c;
    }
    .signal-details {
      padding-right: 15px;
    }
    .signal-details li {
      margin: 10px 0;
      list-style-type: disc;
    }
    
    /* اندیکاتورها */
    .indicators {
      margin: 30px 0;
    }
    .indicator {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      margin: 10px 0;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    .overbought {
      color: #27ae60;
      font-weight: bold;
    }
    .oversold {
      color: #e74c3c;
      font-weight: bold;
    }
    
    /* وضعیت بارگذاری */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* وضعیت خطا */
    .error {
      padding: 20px;
      background-color: rgba(231, 76, 60, 0.1);
      border-right: 4px solid #e74c3c;
      border-radius: 8px;
      color: #e74c3c;
      text-align: center;
    }
    
    /* جدول اندیکاتورها */
    .indicator-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .indicator-table th, .indicator-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #ddd;
    }
    .indicator-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .indicator-table tr:hover {
      background-color: #f5f5f5;
    }
    .positive {
      color: #27ae60;
      font-weight: bold;
    }
    .negative {
      color: #e74c3c;
      font-weight: bold;
    }
    
    /* کارت‌های اندیکاتور */
    .indicator-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .indicator-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 4px solid #3498db;
    }
    .indicator-card h4 {
      margin-top: 0;
      color: #2c3e50;
    }
    .indicator-card .value {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
    }
    .indicator-card.buy {
      border-left-color: #27ae60;
    }
    .indicator-card.sell {
      border-left-color: #e74c3c;
    }
    
    /* پیش‌بینی قیمت */
    .price-prediction {
      padding: 20px;
      background-color: rgba(52, 152, 219, 0.1);
      border-right: 4px solid #3498db;
      border-radius: 10px;
      margin: 20px 0;
    }
    .prediction-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed #ddd;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>تحلیلگر ایران افیکس</h1>
    <img src="https://app.puzzley.net/uploads/user/5VoB/app/iconiranfx.png" alt="لوگوی ایران افیکس" class="logo">
  </div>

  <div class="container">
    <div class="input-group">
      <input type="text" id="symbol-input" placeholder="مثلاً BTC, ETH, XAU, EURUSD" list="symbols-list">
      <datalist id="symbols-list"></datalist>
      <button id="analyze-btn">تحلیل کن</button>
    </div>
    
    <div id="analysis-result">
      <p style="text-align: center; color: #666;">لطفاً نماد مورد نظر را انتخاب کنید</p>
    </div>
  </div>

  <script>
    // بارگذاری نمادهای موجود
    async function loadSymbols() {
      try {
        const response = await fetch('/api/symbols');
        const symbols = await response.json();
        
        const datalist = document.getElementById('symbols-list');
        datalist.innerHTML = '';
        
        for (const [symbol, name] of Object.entries(symbols)) {
          const option = document.createElement('option');
          option.value = symbol;
          option.textContent = `${symbol} (${name})`;
          datalist.appendChild(option);
        }
      } catch (error) {
        console.error('خطا در دریافت نمادها:', error);
      }
    }

    // تحلیل نماد
    document.getElementById('analyze-btn').addEventListener('click', async () => {
      const symbol = document.getElementById('symbol-input').value.trim().toUpperCase();
      
      if (!symbol) {
        alert('لطفاً نماد مورد نظر را وارد کنید');
        return;
      }

      const resultDiv = document.getElementById('analysis-result');
      resultDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>در حال تحلیل نماد ${symbol} ...</p>
        </div>
      `;
      
      try {
        const response = await fetch(`/api/analyze/${symbol}`);
        if (!response.ok) {
          throw new Error('خطا در دریافت داده از سرور');
        }
        
        const data = await response.json();
        renderAnalysis(data);
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <p>خطا در تحلیل نماد</p>
            <p>${error.message}</p>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 15px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
              تلاش مجدد
            </button>
          </div>
        `;
      }
    });

    // نمایش نتایج تحلیل
    function renderAnalysis(data) {
      const signalClass = data.signal.decision === 'خرید' ? 'signal-buy' : 'signal-sell';
      const rsiClass = data.indicators.rsi < 30 ? 'oversold' : 
                      data.indicators.rsi > 70 ? 'overbought' : '';
      const stochasticClass = data.indicators.stochastic.k < 20 ? 'oversold' : 
                           data.indicators.stochastic.k > 80 ? 'overbought' : '';
      
      document.getElementById('analysis-result').innerHTML = `
        <div style="margin-bottom: 30px;">
          <h2 style="text-align: center; color: #2c3e50;">${data.name} (${data.symbol})</h2>
          <p style="text-align: center; font-size: 24px; font-weight: bold; color: ${data.trend === 'صعودی' ? '#27ae60' : '#e74c3c'}">
            قیمت فعلی: ${formatPrice(data.lastPrice)}
          </p>
          <p style="text-align: center; color: #7f8c8d;">
            آخرین به‌روزرسانی: ${new Date(data.lastUpdate).toLocaleString('fa-IR')}
          </p>
        </div>
        
        <!-- نمودار میله‌ای قدرت خریداران/فروشندگان -->
        <div class="bar-container">
          <div class="bar-title">
            <span class="buy-title">خریداران: ${data.marketStrength.buyerPower}%</span>
            <span class="sell-title">فروشندگان: ${data.marketStrength.sellerPower}%</span>
          </div>
          <div class="bar-chart">
            <div class="buy-bar" style="width: ${data.marketStrength.buyerPower}%">
              ${data.marketStrength.buyerPower}%
            </div>
            <div class="sell-bar" style="width: ${data.marketStrength.sellerPower}%">
              ${data.marketStrength.sellerPower}%
            </div>
          </div>
        </div>
        
        <!-- سطوح حمایت و مقاومت -->
        <div class="levels-container">
          <div class="supports">
            <h3 style="color: #27ae60;">سطوح حمایت</h3>
            <div class="level-item">
              <span>حمایت قوی:</span>
              <span style="font-weight: bold;">${formatPrice(data.supports[0])}</span>
              <span style="color: #666;">(${calculateDistance(data.lastPrice, data.supports[0])}%)</span>
            </div>
            <div class="level-item">
              <span>حمایت متوسط:</span>
              <span style="font-weight: bold;">${formatPrice(data.supports[1])}</span>
              <span style="color: #666;">(${calculateDistance(data.lastPrice, data.supports[1])}%)</span>
            </div>
          </div>
          
          <div class="resistances">
            <h3 style="color: #e74c3c;">سطوح مقاومت</h3>
            <div class="level-item">
              <span>مقاومت قوی:</span>
              <span style="font-weight: bold;">${formatPrice(data.resistances[0])}</span>
              <span style="color: #666;">(${calculateDistance(data.lastPrice, data.resistances[0])}%)</span>
            </div>
            <div class="level-item">
              <span>مقاومت متوسط:</span>
              <span style="font-weight: bold;">${formatPrice(data.resistances[1])}</span>
              <span style="color: #666;">(${calculateDistance(data.lastPrice, data.resistances[1])}%)</span>
            </div>
          </div>
        </div>
        
        <!-- سیگنال -->
        <div class="signal ${signalClass}">
          <h3 class="signal-title">
            سیگنال: ${data.signal.decision} (اطمینان: ${data.signal.confidence}%)
          </h3>
          <p style="margin-bottom: 15px; font-weight: bold;">
            امتیاز خرید: ${data.signal.buyPoints.toFixed(1)} | امتیاز فروش: ${data.signal.sellPoints.toFixed(1)}
          </p>
          <ul class="signal-details">
            ${data.signal.details.map(detail => `<li>${detail}</li>`).join('')}
          </ul>
        </div>
        
        <!-- اندیکاتورهای تکنیکال -->
        <div class="indicators">
          <h3 style="color: #2c3e50;">اندیکاتورهای تکنیکال</h3>
          
          <div class="indicator-cards">
            <!-- RSI -->
            <div class="indicator-card ${rsiClass.includes('over') ? (rsiClass === 'oversold' ? 'buy' : 'sell') : ''}">
              <h4>RSI (14)</h4>
              <div class="value ${rsiClass}">
                ${data.indicators.rsi.toFixed(2)}
                ${data.indicators.rsi < 30 ? '(اشباع فروش)' : data.indicators.rsi > 70 ? '(اشباع خرید)' : ''}
              </div>
              <p>${getRSIInterpretation(data.indicators.rsi)}</p>
            </div>
            
            <!-- MACD -->
            <div class="indicator-card ${data.indicators.macd.MACD > data.indicators.macd.signal ? 'buy' : 'sell'}">
              <h4>MACD</h4>
              <div class="value" style="color: ${data.indicators.macd.MACD > data.indicators.macd.signal ? '#27ae60' : '#e74c3c'};">
                ${data.indicators.macd.MACD.toFixed(4)}
                ${data.indicators.macd.MACD > data.indicators.macd.signal ? '(صعودی)' : '(نزولی)'}
              </div>
              <p>خط MACD: ${data.indicators.macd.MACD.toFixed(4)}</p>
              <p>خط سیگنال: ${data.indicators.macd.signal.toFixed(4)}</p>
            </div>
            
            <!-- Stochastic -->
            <div class="indicator-card ${stochasticClass.includes('over') ? (stochasticClass === 'oversold' ? 'buy' : 'sell') : ''}">
              <h4>Stochastic (14,3)</h4>
              <div class="value ${stochasticClass}">
                K: ${data.indicators.stochastic.k.toFixed(2)}, D: ${data.indicators.stochastic.d.toFixed(2)}
                ${data.indicators.stochastic.k < 20 ? '(اشباع فروش)' : data.indicators.stochastic.k > 80 ? '(اشباع خرید)' : ''}
              </div>
              <p>${getStochasticInterpretation(data.indicators.stochastic.k, data.indicators.stochastic.d)}</p>
            </div>
            
            <!-- میانگین‌های متحرک -->
            <div class="indicator-card ${data.indicators.goldenCross ? 'buy' : 'sell'}">
              <h4>میانگین‌های متحرک</h4>
              <div class="value" style="color: ${data.indicators.goldenCross ? '#27ae60' : '#e74c3c'};">
                ${data.indicators.goldenCross ? 'تقاطع طلایی' : 'تقاطع مرگ'}
              </div>
              <p>SMA50: ${formatPrice(data.indicators.sma50)}</p>
              <p>SMA200: ${formatPrice(data.indicators.sma200)}</p>
              <p>قیمت ${data.indicators.priceAboveSMA50 ? 'بالای' : 'زیر'} SMA50 و ${data.indicators.priceAboveSMA200 ? 'بالای' : 'زیر'} SMA200</p>
            </div>
            
            <!-- باندهای بولینگر -->
            <div class="indicator-card">
              <h4>باندهای بولینگر (20,2)</h4>
              <div class="value">
                ${formatPrice(data.indicators.bollinger.middle)}
              </div>
              <p>باند بالایی: ${formatPrice(data.indicators.bollinger.upper)}</p>
              <p>باند پایینی: ${formatPrice(data.indicators.bollinger.lower)}</p>
              <p>قیمت ${data.lastPrice > data.indicators.bollinger.upper ? 'بالای باند بالایی' : 
                      data.lastPrice < data.indicators.bollinger.lower ? 'زیر باند پایینی' : 'بین باندها'}</p>
            </div>
          </div>
        </div>
        
        <!-- پیش‌بینی قیمت -->
        <div class="price-prediction">
          <h3 style="color: #3498db;">پیش‌بینی قیمت</h3>
          <div class="prediction-item">
            <span>هدف قیمتی کوتاه‌مدت:</span>
            <span style="font-weight: bold; color: ${data.signal.decision === 'خرید' ? '#27ae60' : '#e74c3c'}">
              ${formatPrice(calculatePrediction(data.lastPrice, data.signal.decision, data.resistances, data.supports))}
            </span>
          </div>
          <div class="prediction-item">
            <span>حد ضرر پیشنهادی:</span>
            <span style="font-weight: bold; color: #e74c3c">
              ${formatPrice(calculateStopLoss(data.lastPrice, data.signal.decision, data.supports))}
            </span>
          </div>
          <div class="prediction-item" style="border-bottom: none;">
            <span>پتانسیل سود/زیان:</span>
            <span style="font-weight: bold; color: ${calculateProfitPotential(data.lastPrice, data.signal.decision, data.resistances, data.supports) > 0 ? '#27ae60' : '#e74c3c'}">
              ${calculateProfitPotential(data.lastPrice, data.signal.decision, data.resistances, data.supports).toFixed(2)}%
            </span>
          </div>
        </div>
      `;
    }
    
    // توابع کمکی
    function formatPrice(price) {
      if (price > 1000) {
        return price.toLocaleString('fa-IR');
      } else if (price > 1) {
        return price.toFixed(2).replace('.', ',');
      } else {
        return price.toFixed(4).replace('.', ',');
      }
    }
    
    function calculateDistance(currentPrice, levelPrice) {
      return Math.abs(((currentPrice - levelPrice) / currentPrice) * 100).toFixed(2);
    }
    
    function getRSIInterpretation(rsi) {
      if (rsi < 30) return 'سیگنال قوی خرید - بازار احتمالاً اشباع فروش شده است';
      if (rsi > 70) return 'سیگنال قوی فروش - بازار احتمالاً اشباع خرید شده است';
      if (rsi < 45) return 'تمایل به فروش - ممکن است روند نزولی ادامه یابد';
      if (rsi > 55) return 'تمایل به خرید - ممکن است روند صعودی ادامه یابد';
      return 'خنثی - بازار در حال تعادل است';
    }
    
    function getStochasticInterpretation(k, d) {
      if (k < 20 && d < 20) return 'سیگنال قوی خرید - بازار احتمالاً اشباع فروش شده است';
      if (k > 80 && d > 80) return 'سیگنال قوی فروش - بازار احتمالاً اشباع خرید شده است';
      if (k > d) return 'تمایل به خرید - ممکن است روند صعودی شود';
      if (k < d) return 'تمایل به فروش - ممکن است روند نزولی شود';
      return 'خنثی - بازار در حال تعادل است';
    }
    
    function calculatePrediction(currentPrice, decision, resistances, supports) {
      if (decision === 'خرید') {
        // میانگین مقاومت‌ها به عنوان هدف قیمتی
        const avgResistance = (resistances[0] + resistances[1]) / 2;
        return avgResistance > currentPrice ? avgResistance : currentPrice * 1.02;
      } else {
        // میانگین حمایت‌ها به عنوان هدف قیمتی
        const avgSupport = (supports[0] + supports[1]) / 2;
        return avgSupport < currentPrice ? avgSupport : currentPrice * 0.98;
      }
    }
    
    function calculateStopLoss(currentPrice, decision, supports) {
      if (decision === 'خرید') {
        // حمایت قوی به عنوان حد ضرر
        return supports[0] < currentPrice ? supports[0] : currentPrice * 0.98;
      } else {
        // مقاومت قوی به عنوان حد ضرر (برای موقعیت‌های فروش)
        return supports[0] > currentPrice ? supports[0] : currentPrice * 1.02;
      }
    }
    
    function calculateProfitPotential(currentPrice, decision, resistances, supports) {
      if (decision === 'خرید') {
        const target = calculatePrediction(currentPrice, decision, resistances, supports);
        const stopLoss = calculateStopLoss(currentPrice, decision, supports);
        return ((target - currentPrice) / (currentPrice - stopLoss)) * 100;
      } else {
        const target = calculatePrediction(currentPrice, decision, resistances, supports);
        const stopLoss = calculateStopLoss(currentPrice, decision, supports);
        return ((currentPrice - target) / (stopLoss - currentPrice)) * 100;
      }
    }

    // بارگذاری اولیه نمادها
    loadSymbols();
  </script>
</body>
</html>
